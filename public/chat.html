<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë…ê° ì˜ˆë°© ë°±ì‹  ì±—ë´‡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--text:#1f2430;--muted:#667085;--brand:#0b57d0;--ring:#d0d5dd;--bot:#f2f4f7}
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:'Noto Sans KR',system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,sans-serif;display:flex;align-items:center;justify-content:center;padding:24px}
    .shell{width:100%;max-width:900px}
    .card{background:var(--card);border:1px solid var(--ring);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.06);overflow:hidden}
    .header{display:flex;align-items:center;justify-content:space-between;padding:18px 20px;border-bottom:1px solid var(--ring)}
    .title{font-size:20px;font-weight:700}
    .chat{height:min(60vh,560px);overflow:auto;padding:18px;display:flex;gap:14px;flex-direction:column;scroll-behavior:smooth;background:#fafbff}
    .row{display:flex;gap:10px;align-items:flex-end}
    .row.user{justify-content:flex-end}
    .row.bot{justify-content:flex-start}
    .avatar{width:34px;height:34px;border-radius:50%;flex:0 0 34px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:#fff;background:#0b57d0}
    .row.bot .avatar{background:#64748b}
    .bubble{max-width:72%;padding:12px 14px;border-radius:16px;line-height:1.55;word-break:break-word;white-space:pre-wrap;border:1px solid var(--ring);box-shadow:0 2px 6px rgba(0,0,0,.05)}
    .row.user .bubble{background:var(--brand);color:#fff;border-color:transparent}
    .row.bot .bubble{background:var(--bot)}
    .footer{padding:14px 18px;border-top:1px solid var(--ring);display:block;gap:10px;align-items:center}
    .muted{font-size:14px;color:var(--muted)}
    .dots{display:inline-flex;gap:6px;align-items:center}
    .dot{width:6px;height:6px;border-radius:50%;background:var(--muted);opacity:.35;animation:blink 1.2s infinite}
    .dot:nth-child(2){animation-delay:.15s}.dot:nth-child(3){animation-delay:.3s}
    @keyframes blink{0%,80%,100%{opacity:.2}40%{opacity:1}}
    button,input{font-family:inherit}
    .btn{appearance:none;border:1px solid var(--ring);background:var(--brand);color:#fff;padding:10px 14px;font-weight:700;font-size:16px;border-radius:12px;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed;pointer-events:none}
    .row-input{display:flex;gap:10px;width:100%}
    .txt{flex:1;padding:12px;border:1px solid var(--ring);border-radius:12px;font-size:16px}
.timer {
  font-size: 28px;      /* ê¸€ì í¬ê¸° í¬ê²Œ */
  font-weight: 700;
  padding: 8px 16px;    /* ì•ˆìª½ ì—¬ë°± ë„‰ë„‰íˆ */
  border: 2px solid var(--ring);
  border-radius: 12px;
  background: #fff;
  color: #0b57d0;       /* ê¸°ë³¸ì€ íŒŒë€ìƒ‰ */
  transition: color 0.3s ease;
}

    audio{display:none}
    body.voice .chat{display:none} /* ë³´ì´ìŠ¤ ëª¨ë“œ: ëŒ€í™” UI ì „ì²´ ìˆ¨ê¹€ */
    #codeBox {
  display: none; 
  justify-content: space-between; 
  align-items: center;
  padding: 14px 18px;
  border-top: 2px solid var(--ring);
  background: #fff5f5; /* ì€ì€í•œ ë¶„í™ ë°°ê²½ */
}

#codeText {
  font-size: 32px;    /* í¼ì§í•˜ê²Œ */
  font-weight: 900;
  color: #dc2626;     /* ì§„í•œ ë¹¨ê°• */
  letter-spacing: 2px;
}

#copyCode {
  appearance: none;
  border: none;
  background: #dc2626;  /* ë¹¨ê°„ ë²„íŠ¼ */
  color: #fff;
  padding: 10px 16px;
  font-weight: 700;
  font-size: 16px;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s ease;
}
#copyCode:hover {
  background: #b91c1c; /* hover ì‹œ ë” ì–´ë‘ìš´ ë¹¨ê°• */
}

body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
  font-family: 'Noto Sans KR', system-ui, Segoe UI, Roboto, Apple SD Gothic Neo, sans-serif;
  min-height: 100vh;   /* ê¸°ë³¸: ì˜›ë‚  ë¸Œë¼ìš°ì €ìš© */
  display: block;
  padding: 40px 16px;  /* ìœ„ì•„ë˜ 40px, ì¢Œìš° 16px ì—¬ë°± */
  box-sizing: border-box;

  overflow-x: hidden;  /* âœ… ê°€ë¡œ ì˜ë¦¼/ë°€ë¦¼ ë°©ì§€ */
}

@supports (height: 100dvh) {
  body {
    min-height: 100dvh; /* âœ… ìµœì‹  ë¸Œë¼ìš°ì €: ë™ì  ë·°í¬íŠ¸ ë°˜ì˜ */
  }
}

/* âœ… ì»¨í…Œì´ë„ˆë„ ê°•ì œë¡œ ê°€ë¡œ ë„˜ì¹¨ ë°©ì§€ */
.shell, .card, .row-input {
  max-width: 100%;
  box-sizing: border-box;
}
.row-input .txt {
  flex: 1 1 auto;
  min-width: 0; /* ì…ë ¥ì°½ì´ ë²„íŠ¼ ë°€ì–´ë‚´ì§€ ì•Šê²Œ */
}
    
  .guide-box {
    background: #fefce8;        /* ì—°í•œ ë…¸ë‘ ë°°ê²½ */
    border: 1px solid #facc15;  /* ì§„í•œ ë…¸ë‘ í…Œë‘ë¦¬ */
    border-radius: 12px;
    padding: 12px 16px;
    margin: 12px 18px;          /* ìƒë‹¨/ì¢Œìš° ì—¬ë°± */
    font-size: 15px;
    line-height: 1.5;
    color: #1f2937;             /* ê¸€ì ì§„í•œ íšŒìƒ‰ */
  }
  .guide-box strong {
    color: #b45309;             /* í‚¤ì›Œë“œ ê°•ì¡° ìƒ‰ìƒ */
  }
/* âœ… ì—¬ê¸° ì¶”ê°€ */
.big-speak {
  display: block;
  width: 100%;
  padding: 20px;
  font-size: 20px;
  font-weight: 700;
  border-radius: 14px;
  background: #0b57d0;
  color: #fff;
  border: none;
  cursor: pointer;
  text-align: center;
  transition: background 0.3s ease;
}
.big-speak:disabled {
  background: #9bb7e0;
  cursor: not-allowed;
}
  </style>
</head>
<body>
  <div class="shell">
    <div class="card">
      <div class="header">
        <div class="title" id="title">ë…ê° ì˜ˆë°© ë°±ì‹  ì±—ë´‡</div>
        <div id="countdown" class="timer" aria-live="polite">03:00</div>
  </div> <!-- âœ… header ë‹«ê¸° -->
    
      <div class="guide-box">
  <p><strong>ëŒ€í™” ê·œì¹™</strong></p>
  <ul style="margin: 6px 0 10px 18px; padding: 0;">
    <li>3ê°€ì§€ í‚¤ì›Œë“œ(ì ‘ì¢… íš¨ê³¼, ì•ˆì „ì„±, í•„ìš”ì„±)ì— ëŒ€í•´ 1ë²ˆ ì´ìƒ ì§ˆë¬¸í•´ ì£¼ì„¸ìš”.</li>
    <li>í•œ ë²ˆì— í•˜ë‚˜ì˜ í‚¤ì›Œë“œì— ëŒ€í•´ ì§ˆë¬¸í•´ ì£¼ì„¸ìš”.</li>
    <li>3ë¶„ ë’¤ ëŒ€í™”ê°€ ìë™ ì¢…ë£Œë©ë‹ˆë‹¤.</li>
  </ul>
  <p><strong>ì§ˆë¬¸ ì˜ˆì‹œ</strong></p>
  <ul style="margin: 6px 0 0 18px; padding: 0;">
    <li>ì²« ëŒ€í™”: â€œì•ˆë…•!â€, â€œë°˜ê°€ì›Œ!â€</li>
    <li>ì ‘ì¢… íš¨ê³¼: "íš¨ê³¼ê°€ ìˆë‚˜ìš”?", "ì˜ˆë°© íš¨ê³¼ê°€ ìˆë‚˜ìš”?"</li>
    <li>ì•ˆì „ì„±: "ì•ˆì „í•œê°€ìš”?", "ëˆ„êµ¬ë‚˜ ë§ì•„ë„ ë˜ë‚˜ìš”?"</li>
    <li>í•„ìš”ì„±: "ì ‘ì¢…ì´ í•„ìš”í•œê°€ìš”?", "ê¼­ ë§ì•„ì•¼ í•˜ë‚˜ìš”?"</li>
  </ul>
</div>
      <div id="tip" class="muted" style="padding:8px 18px; font-size:14px; color:#64748b;">
  Tip: ì…ë ¥ì°½ì— ì§ˆë¬¸ì„ ì ê³  â€œë³´ë‚´ê¸°â€ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.
</div>
      <div id="chat" class="chat" aria-live="polite" aria-label="ëŒ€í™” ë‚´ìš©"></div>
      <div class="footer" id="textControls" style="display:none">
        <div class="row-input">
          <input class="txt" id="userInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”." autocomplete="off" />
          <button class="btn" id="sendBtn">ë³´ë‚´ê¸°</button>
        </div>
      </div>
      <div class="footer">
  <button id="speak" class="btn big-speak">ì—¬ê¸°ë¥¼ ëˆ„ë¥´ê³  ë§ì”€í•˜ì„¸ìš”</button>
</div>

<!-- â–¼ ì—¬ê¸° ì½”ë“œ ë°•ìŠ¤ ìˆ˜ì • -->
<div class="footer" id="codeBox" style="display:block; justify-content:space-between; align-items:center">
  <div class="muted">
    ë³¸ì¸ í™•ì¸ ì½”ë“œ: <strong id="codeText"></strong> (ëŒ€í™” ì¢…ë£Œ í›„ ì„¤ë¬¸ì—ì„œ ì…ë ¥)
  </div>
  <button class="btn" id="copyCode">ì½”ë“œ ë³µì‚¬</button>
</div>

<!-- â–² ì—¬ê¸°ê¹Œì§€ -->

</div> <!-- card ë‹«í˜ -->
</div> <!-- shell ë‹«í˜ -->

    </div>
  </div>

  <audio id="botAudio"></audio>

  <script>
    const params = new URLSearchParams(location.search);
    const cond = (params.get('cond') || 'text').toLowerCase();
    const pid = params.get('pid') || (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()));

    // 1) api íŒŒë¼ë¯¸í„° > 2) ê°™ì€ ì¶œì²˜ > 3) Render ê¸°ë³¸ê°’
    const DEFAULT_RENDER = 'https://<render-app>.onrender.com'; // â† ì‹¤ì œ ì£¼ì†Œë¡œ êµì²´
    const API_BASE = (params.get('api') || (location.origin.startsWith('http') ? location.origin : DEFAULT_RENDER)).replace(/\/$/, '');

    const chat = document.getElementById('chat');
    const speakBtn = document.getElementById('speak');
speakBtn.textContent = "ì—¬ê¸°ë¥¼ ëˆ„ë¥´ê³  ë§ì”€í•˜ì„¸ìš”";  // 1) ê¸°ë³¸ ìƒíƒœ
    const title = document.getElementById('title');
    const tip = document.getElementById('tip');
    const speakBtn = document.getElementById('speak');
    const botAudio = document.getElementById('botAudio');
    const textControls = document.getElementById('textControls');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    // ì„¸ì…˜ìš© 4ìë¦¬ ì½”ë“œ(ê°„ë‹¨ ë²„ì „) â€” 6ìë¦¬ë¡œ ì›í•˜ë©´ *1000000, padStart(6,'0')ë¡œ ë³€ê²½
const surveyCode = String(Math.floor(Math.random()*10000)).padStart(4,'0');

const codeBox  = document.getElementById('codeBox');
const codeText = document.getElementById('codeText');
    if (codeBox && codeText) {
  codeText.textContent = surveyCode;
  codeBox.style.display = 'flex';
}
const copyCode = document.getElementById('copyCode');


    // ===== 3ë¶„ ì¹´ìš´íŠ¸ë‹¤ìš´ í‘œì‹œë§Œ ì¶”ê°€ =====
const COUNTDOWN_MS = 180000; // 3ë¶„
const startTs = Date.now();
const countdownEl = document.getElementById('countdown');

const tick = setInterval(() => {
  const remain = Math.max(0, COUNTDOWN_MS - (Date.now() - startTs));
  const mm = String(Math.floor(remain / 60000)).padStart(2, '0');
  const ss = String(Math.floor((remain % 60000) / 1000)).padStart(2, '0');

  if (countdownEl) {
    countdownEl.textContent = `${mm}:${ss}`;

    // ìƒ‰ìƒ ë³€í™” ë¡œì§
    if (remain <= 30000) {
      countdownEl.style.color = '#dc2626'; // 30ì´ˆ ì´í•˜ â†’ ë¹¨ê°•
    } else if (remain <= 60000) {
      countdownEl.style.color = '#d97706'; // 1ë¶„ ì´í•˜ â†’ ì£¼í™©
    } else {
      countdownEl.style.color = '#0b57d0'; // ê¸°ë³¸ íŒŒë‘
    }
  }

  if (remain === 0) clearInterval(tick);
}, 250);


// ğŸ”’ ìŒì„±(TTS) ì¬ìƒ ì¤‘ì—ëŠ” ëª¨ë“  ì…ë ¥ ì ê¸ˆ, ëë‚˜ë©´ í•´ì œ
botAudio.addEventListener('play', () => {
  speakBtn.textContent = "ì±—ë´‡ì´ ë§í•˜ëŠ” ì¤‘ì´ì—ìš”";
  if (cond === 'voice' && speakBtn) speakBtn.disabled = true; // ëˆŒëŸ¬ì„œ ë§í•˜ê¸° ì ê¸ˆ
  if (sendBtn) sendBtn.disabled = true;    // (í…ìŠ¤íŠ¸ UIê°€ ë³´ì´ëŠ” ê²½ìš° ëŒ€ë¹„)
  if (userInput) userInput.disabled = true;
});

const unlockAfterAudio = () => {
  if (isEnded) return;
  if (cond === 'voice' && speakBtn) speakBtn.disabled = false; // ë³´ì´ìŠ¤ ë²„íŠ¼ í•´ì œ

  // í…ìŠ¤íŠ¸ UIê°€ ì—´ë ¤ìˆëŠ” ê²½ìš°ì—ë§Œ ë³µêµ¬
  if (textControls && textControls.style.display !== 'none') {
    if (sendBtn) sendBtn.disabled = false;
    if (userInput) userInput.disabled = false;
  }
};
botAudio.addEventListener('ended', () => {
  speakBtn.textContent = "ì—¬ê¸°ë¥¼ ëˆ„ë¥´ê³  ë§ì”€í•˜ì„¸ìš”";
  speakBtn.disabled = false;
});
botAudio.addEventListener('error', unlockAfterAudio);


    let isEnded = false;
    let recHandle = null;

    // ëª¨ë“œë³„ ì´ˆê¸° UI
    if (cond === 'voice') {
  document.body.classList.add('voice');
  title.textContent = 'ë…ê° ì˜ˆë°© ì ‘ì¢…ì— ëŒ€í•´ ë¬¼ì–´ë³´ì„¸ìš”! (ì ‘ì¢… íš¨ê³¼, ì•ˆì „ì„±, í•„ìš”ì„±)';
  speakBtn.style.display = 'inline-block';
  textControls.style.display = 'none';
  tip.style.display = 'none'; // âœ… ë³´ì´ìŠ¤ ëª¨ë“œì—ì„œëŠ” tip ìˆ¨ê¹€
} else {
  title.textContent = 'ë…ê° ì˜ˆë°© ì ‘ì¢…ì— ëŒ€í•´ ë¬¼ì–´ë³´ì„¸ìš”! (ì ‘ì¢… íš¨ê³¼, ì•ˆì „ì„±, í•„ìš”ì„±)';
  speakBtn.style.display = 'none';
  textControls.style.display = 'flex';
  tip.style.display = 'block'; 
  tip.textContent = 'Tip: ì…ë ¥ì°½ì— ì§ˆë¬¸ì„ ì ê³  â€œë³´ë‚´ê¸°â€ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.';
}


    // ì±„íŒ… ë§í’ì„  ìœ í‹¸(í…ìŠ¤íŠ¸ ëª¨ë“œì—ì„œë§Œ ì‹œê°ì ìœ¼ë¡œ ë³´ì„)
    function addMsg(role, text, asThinking=false){
      const row = document.createElement('div');
      row.className = `row ${role}`;
      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.textContent = role === 'user' ? 'ìœ ì €' : 'ì±—ë´‡';
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      if(asThinking){
        const wrap = document.createElement('div');
        wrap.className = 'dots';
        wrap.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
        bubble.appendChild(wrap);
      }else{
        bubble.textContent = text;
      }
      if(role === 'bot'){ row.appendChild(avatar); row.appendChild(bubble); }
      else { row.appendChild(bubble); row.appendChild(avatar); }
      chat.appendChild(row); chat.scrollTop = chat.scrollHeight;
      return {row,bubble};
    }
    const updateThinking = (el,text) => { if(el) el.textContent = text; };

    // í…ìŠ¤íŠ¸ ëª¨ë“œ ì „ì†¡
    async function sendText(){
      if (isEnded) return;
      const text = userInput.value.trim(); if(!text) return;
      userInput.value = '';
      addMsg('user', text);
      const thinking = addMsg('bot', '', true);
speakBtn.textContent = "ì±—ë´‡ì´ ë‹µë³€ì„ ì¤€ë¹„í•˜ê³  ìˆì–´ìš”...";

      try{
        const t0 = performance.now();
       // 2ï¸âƒ£ ë³€í™˜ëœ í…ìŠ¤íŠ¸ë¥¼ /query ë¡œ ì „ë‹¬
const r = await fetch(`${API_BASE}/query`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ text, lang: 'ko', cond: 'voice', pid, code: surveyCode }) // ğŸ”‘ voiceë¡œ ê³ ì •
});

        const data = await r.json();
        const reply = data.reply || '(ì‘ë‹µ ì—†ìŒ)';
        // detectIntent ì‘ë‹µ ë°›ìë§ˆì
updateThinking(thinking.bubble, reply); // âœ… ë°”ë¡œ í‘œì‹œ

if (cond === 'voice' && data.audio) {
  botAudio.src = `data:${data.mime || 'audio/mpeg'};base64,${data.audio}`;
  botAudio.onended = () => { speakBtn.disabled = false; };
  botAudio.onerror = () => { speakBtn.disabled = false; };
  speakBtn.disabled = true;
  try { await botAudio.play(); } catch(_) { speakBtn.disabled = false; }
}


        window.parent?.postMessage({pid,cond,rt_ms:Math.round(performance.now()-t0),user:text,bot:reply},'*');
      }catch(e){
        updateThinking(thinking.bubble,'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
      }
    }

    // ë³´ì´ìŠ¤: í•œ ë²ˆ ëˆŒëŸ¬ 1ë¬¸ì¥ ì¸ì‹ â†’ TTS ëë‚  ë•Œê¹Œì§€ ë²„íŠ¼ ì ê¸ˆ
    // ===== ë³´ì´ìŠ¤ ëª¨ë“œ: ìŒì„± ì¸ì‹ =====
async function startRecognize() {
  if (isEnded) return;

  try {
    // ğŸ‘‰ ì§ˆë¬¸í•  ë•Œë§ˆë‹¤ ìƒˆ stream ìš”ì²­
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm;codecs=opus' });

    let chunks = [];
    mediaRecorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };

    mediaRecorder.onstop = async () => {
      const blob = new Blob(chunks, { type: 'audio/webm;codecs=opus' });
      chunks = [];

      // âœ… ëª¨ë°”ì¼ í˜¸í™˜: ìŠ¤íŠ¸ë¦¼ ë‹«ì•„ì£¼ê¸°
      stream.getTracks().forEach(t => t.stop());

      const formData = new FormData();
      formData.append('file', blob, 'voice.webm');

      try {
        // 1ï¸âƒ£ ì„œë²„ /stt í˜¸ì¶œ
        const sttRes = await fetch(`${API_BASE}/stt`, { method: 'POST', body: formData });
        const sttData = await sttRes.json();
        const text = sttData.text;

        if (!text) { speakBtn.disabled = false; return; }

        addMsg('user', text);

        // 2ï¸âƒ£ ë³€í™˜ëœ í…ìŠ¤íŠ¸ë¥¼ /query ë¡œ ì „ë‹¬
        const r = await fetch(`${API_BASE}/query`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text, lang: 'ko', cond, pid, code: surveyCode })
        });
        const data = await r.json();

        if (data.reply) addMsg('bot', data.reply);

        if (data.audio) {
          botAudio.src = `data:${data.mime || 'audio/mpeg'};base64,${data.audio}`;
          botAudio.onended = () => { speakBtn.disabled = false; };
          botAudio.onerror = () => { speakBtn.disabled = false; };
          try { await botAudio.play(); } catch { speakBtn.disabled = false; }
        } else {
          speakBtn.disabled = false;
        }
      } catch (err) {
        console.error('STT/query error:', err);
        speakBtn.disabled = false;
      }
    };
mediaRecorder.onstart = () => {
  speakBtn.textContent = "ë§ì”€ ì¤‘ì…ë‹ˆë‹¤...";
  speakBtn.disabled = true;
};
    
    mediaRecorder.start();

    // 3ì´ˆ ë’¤ ìë™ stop
    setTimeout(() => { mediaRecorder.stop(); }, 2000);
    speakBtn.disabled = true;

  } catch (err) {
    console.error('MediaRecorder error:', err);
    speakBtn.disabled = false;
  }
}


    // ì´ë²¤íŠ¸
    if (cond==='voice') speakBtn.addEventListener('click', startRecognize);
    else {
      sendBtn.addEventListener('click', sendText);
      userInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter') sendText(); });
      addMsg('bot','ì•„ë˜ì— ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
    }

    // 3ë¶„ íƒ€ì´ë¨¸: ë³´ì´ìŠ¤ëŠ” ì˜¤ë””ì˜¤ë§Œ, í…ìŠ¤íŠ¸ëŠ” ë§í’ì„ 
    setTimeout(async () => {
      if (isEnded) return;
      isEnded = true;
speakBtn.textContent = "ëŒ€í™”ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤";
speakBtn.disabled = true;
      try { recHandle?.abort?.(); } catch(_) {}

      if (cond === 'voice') {
        try {
          const r = await fetch(`${API_BASE}/end-audio`);
          const data = await r.json();
          if (data.audio) {
            botAudio.src = `data:${data.mime || 'audio/mpeg'};base64,${data.audio}`;
            try { await botAudio.play(); } catch(_) {}
          }
        } catch(_) {}
      } else {
        const thinking = addMsg('bot','',true);
        updateThinking(thinking.bubble, 'ëŒ€í™” ì‹œê°„ì´ ëë‚¬ì–´ìš”. ì„¤ë¬¸ìœ¼ë¡œ ëŒì•„ê°€ ì•„ë˜ ë³¸ì¸í™•ì¸ì½”ë“œë¥¼ ì…ë ¥í•˜ê³  ì´ì–´ì„œ ì‘ë‹µí•´ ì£¼ì„¸ìš”. ê°ì‚¬í•©ë‹ˆë‹¤!');
        // ì•ˆë‚´ ë§í’ì„ ì€ ê·¸ëŒ€ë¡œ ë‘ê³ , í™”ë©´ì— ë³„ë„ ì½”ë“œ ë°•ìŠ¤ í‘œì‹œ
if (codeBox && codeText) {
  codeText.textContent = surveyCode;
  codeBox.style.display = 'flex';
  try { await navigator.clipboard.writeText(surveyCode); } catch(_) {} // (ì„ íƒ) ìë™ ë³µì‚¬
}
      }

      if (userInput) userInput.disabled = true;
      if (sendBtn) sendBtn.disabled = true;
      if (speakBtn) speakBtn.disabled = true;
    }, 180000);
    copyCode?.addEventListener('click', async () => {
  try {
    await navigator.clipboard.writeText(surveyCode);
    copyCode.textContent = 'ë³µì‚¬ë¨!';
    setTimeout(() => (copyCode.textContent = 'ì½”ë“œ ë³µì‚¬'), 1200);
  } catch(_) {}
});

  </script>
</body>
</html>

















