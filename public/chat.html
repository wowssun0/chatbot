<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ë…ê° ì˜ˆë°© ë°±ì‹  ì±—ë´‡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--text:#1f2430;--muted:#667085;--brand:#0b57d0;--ring:#d0d5dd;--bot:#f2f4f7}
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:'Noto Sans KR',system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,sans-serif;display:flex;align-items:center;justify-content:center;padding:24px}
    .shell{width:100%;max-width:900px}
    .card{background:var(--card);border:1px solid var(--ring);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.06);overflow:hidden}
    .header{display:flex;align-items:center;justify-content:space-between;padding:18px 20px;border-bottom:1px solid var(--ring)}
    .title{font-size:20px;font-weight:700}
    .chat{height:min(60vh,560px);overflow:auto;padding:18px;display:flex;gap:14px;flex-direction:column;scroll-behavior:smooth;background:#fafbff}
    .row{display:flex;gap:10px;align-items:flex-end}
    .row.user{justify-content:flex-end}
    .row.bot{justify-content:flex-start}
    .avatar{width:34px;height:34px;border-radius:50%;flex:0 0 34px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:#fff;background:#0b57d0}
    .row.bot .avatar{background:#64748b}
    .bubble{max-width:72%;padding:12px 14px;border-radius:16px;line-height:1.55;word-break:break-word;white-space:pre-wrap;border:1px solid var(--ring);box-shadow:0 2px 6px rgba(0,0,0,.05)}
    .row.user .bubble{background:var(--brand);color:#fff;border-color:transparent}
    .row.bot .bubble{background:var(--bot)}
    .footer{padding:14px 18px;border-top:1px solid var(--ring);display:flex;gap:10px;align-items:center}
    .muted{font-size:14px;color:var(--muted)}
    .dots{display:inline-flex;gap:6px;align-items:center}
    .dot{width:6px;height:6px;border-radius:50%;background:var(--muted);opacity:.35;animation:blink 1.2s infinite}
    .dot:nth-child(2){animation-delay:.15s}.dot:nth-child(3){animation-delay:.3s}
    @keyframes blink{0%,80%,100%{opacity:.2}40%{opacity:1}}
    button,input{font-family:inherit}
    .btn{appearance:none;border:1px solid var(--ring);background:var(--brand);color:#fff;padding:10px 14px;font-weight:700;font-size:16px;border-radius:12px;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed;pointer-events:none}
    .row-input{display:flex;gap:10px;width:100%}
    .txt{flex:1;padding:12px;border:1px solid var(--ring);border-radius:12px;font-size:16px}
.timer {
  font-size: 28px;      /* ê¸€ì í¬ê¸° í¬ê²Œ */
  font-weight: 700;
  padding: 8px 16px;    /* ì•ˆìª½ ì—¬ë°± ë„‰ë„‰íˆ */
  border: 2px solid var(--ring);
  border-radius: 12px;
  background: #fff;
  color: #0b57d0;       /* ê¸°ë³¸ì€ íŒŒë€ìƒ‰ */
  transition: color 0.3s ease;
}

    audio{display:none}
    body.voice .chat{display:none} /* ë³´ì´ìŠ¤ ëª¨ë“œ: ëŒ€í™” UI ì „ì²´ ìˆ¨ê¹€ */
    #codeBox {
  display: none; 
  justify-content: space-between; 
  align-items: center;
  padding: 14px 18px;
  border-top: 2px solid var(--ring);
  background: #fff5f5; /* ì€ì€í•œ ë¶„í™ ë°°ê²½ */
}

#codeText {
  font-size: 32px;    /* í¼ì§í•˜ê²Œ */
  font-weight: 900;
  color: #dc2626;     /* ì§„í•œ ë¹¨ê°• */
  letter-spacing: 2px;
}

#copyCode {
  appearance: none;
  border: none;
  background: #dc2626;  /* ë¹¨ê°„ ë²„íŠ¼ */
  color: #fff;
  padding: 10px 16px;
  font-weight: 700;
  font-size: 16px;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s ease;
}
#copyCode:hover {
  background: #b91c1c; /* hover ì‹œ ë” ì–´ë‘ìš´ ë¹¨ê°• */
}

body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
  font-family: 'Noto Sans KR', system-ui, Segoe UI, Roboto, Apple SD Gothic Neo, sans-serif;
  min-height: 100vh;
  display: block;       /* flex ì œê±° â†’ ìŠ¤í¬ë¡¤ ê°€ëŠ¥ */
  padding: 40px 16px;   /* ìœ„ì•„ë˜ 40px, ì¢Œìš° 16px ì—¬ë°± */
}

.shell {
  width: 100%;
  max-width: 900px;
  margin: 0 auto;       /* ê°€ë¡œ ê°€ìš´ë° ì •ë ¬ */
}


  </style>
</head>
<body>
  <div class="shell">
    <div class="card">
      <div class="header">
        <div class="title" id="title">ë…ê° ì˜ˆë°© ë°±ì‹  ì±—ë´‡</div>
        <div id="countdown" class="timer" aria-live="polite">02:00</div>
        <button id="speak" class="btn" style="display:none">ëˆŒëŸ¬ì„œ ë§í•˜ê¸°</button>
      </div>
      <div id="chat" class="chat" aria-live="polite" aria-label="ëŒ€í™” ë‚´ìš©"></div>
      <div class="footer" id="textControls" style="display:none">
        <div class="row-input">
          <input class="txt" id="userInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”." autocomplete="off" />
          <button class="btn" id="sendBtn">ë³´ë‚´ê¸°</button>
        </div>
      </div>
      <div class="footer">
        <div class="muted" id="tip">Tip: â€œë‹¤ìŒâ€ì´ë¼ê³  ë§í•˜ê±°ë‚˜ ì…ë ¥í•´ ë³´ì„¸ìš”.</div>
      </div>

<!-- â–¼ ì—¬ê¸° ì½”ë“œ ë°•ìŠ¤ ìˆ˜ì • -->
<div class="footer" id="codeBox" style="display:none; justify-content:space-between; align-items:center">
  <div class="muted">
    ë³¸ì¸ í™•ì¸ ì½”ë“œ: <strong id="codeText"></strong> (ëŒ€í™” ì¢…ë£Œ í›„ ì„¤ë¬¸ì—ì„œ ì…ë ¥)
  </div>
  <button class="btn" id="copyCode">ì½”ë“œ ë³µì‚¬</button>
</div>

<!-- â–² ì—¬ê¸°ê¹Œì§€ -->

</div> <!-- card ë‹«í˜ -->
</div> <!-- shell ë‹«í˜ -->

    </div>
  </div>

  <audio id="botAudio"></audio>

  <script>
    const params = new URLSearchParams(location.search);
    const cond = (params.get('cond') || 'text').toLowerCase();
    const pid = params.get('pid') || (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()));

    // 1) api íŒŒë¼ë¯¸í„° > 2) ê°™ì€ ì¶œì²˜ > 3) Render ê¸°ë³¸ê°’
    const DEFAULT_RENDER = 'https://<render-app>.onrender.com'; // â† ì‹¤ì œ ì£¼ì†Œë¡œ êµì²´
    const API_BASE = (params.get('api') || (location.origin.startsWith('http') ? location.origin : DEFAULT_RENDER)).replace(/\/$/, '');

    const chat = document.getElementById('chat');
    const title = document.getElementById('title');
    const tip = document.getElementById('tip');
    const speakBtn = document.getElementById('speak');
    const botAudio = document.getElementById('botAudio');
    const textControls = document.getElementById('textControls');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    // ì„¸ì…˜ìš© 4ìë¦¬ ì½”ë“œ(ê°„ë‹¨ ë²„ì „) â€” 6ìë¦¬ë¡œ ì›í•˜ë©´ *1000000, padStart(6,'0')ë¡œ ë³€ê²½
const surveyCode = String(Math.floor(Math.random()*10000)).padStart(4,'0');

const codeBox  = document.getElementById('codeBox');
const codeText = document.getElementById('codeText');
    if (codeBox && codeText) {
  codeText.textContent = surveyCode;
  codeBox.style.display = 'flex';
}
const copyCode = document.getElementById('copyCode');


    // ===== 2ë¶„ ì¹´ìš´íŠ¸ë‹¤ìš´ í‘œì‹œë§Œ ì¶”ê°€ =====
const COUNTDOWN_MS = 120000; // 2ë¶„
const startTs = Date.now();
const countdownEl = document.getElementById('countdown');

const tick = setInterval(() => {
  const remain = Math.max(0, COUNTDOWN_MS - (Date.now() - startTs));
  const mm = String(Math.floor(remain / 60000)).padStart(2, '0');
  const ss = String(Math.floor((remain % 60000) / 1000)).padStart(2, '0');

  if (countdownEl) {
    countdownEl.textContent = `${mm}:${ss}`;

    // ìƒ‰ìƒ ë³€í™” ë¡œì§
    if (remain <= 30000) {
      countdownEl.style.color = '#dc2626'; // 30ì´ˆ ì´í•˜ â†’ ë¹¨ê°•
    } else if (remain <= 60000) {
      countdownEl.style.color = '#d97706'; // 1ë¶„ ì´í•˜ â†’ ì£¼í™©
    } else {
      countdownEl.style.color = '#0b57d0'; // ê¸°ë³¸ íŒŒë‘
    }
  }

  if (remain === 0) clearInterval(tick);
}, 250);


// ğŸ”’ ìŒì„±(TTS) ì¬ìƒ ì¤‘ì—ëŠ” ëª¨ë“  ì…ë ¥ ì ê¸ˆ, ëë‚˜ë©´ í•´ì œ
botAudio.addEventListener('play', () => {
  if (cond === 'voice' && speakBtn) speakBtn.disabled = true; // ëˆŒëŸ¬ì„œ ë§í•˜ê¸° ì ê¸ˆ
  if (sendBtn) sendBtn.disabled = true;    // (í…ìŠ¤íŠ¸ UIê°€ ë³´ì´ëŠ” ê²½ìš° ëŒ€ë¹„)
  if (userInput) userInput.disabled = true;
});

const unlockAfterAudio = () => {
  if (isEnded) return;
  if (cond === 'voice' && speakBtn) speakBtn.disabled = false; // ë³´ì´ìŠ¤ ë²„íŠ¼ í•´ì œ

  // í…ìŠ¤íŠ¸ UIê°€ ì—´ë ¤ìˆëŠ” ê²½ìš°ì—ë§Œ ë³µêµ¬
  if (textControls && textControls.style.display !== 'none') {
    if (sendBtn) sendBtn.disabled = false;
    if (userInput) userInput.disabled = false;
  }
};
botAudio.addEventListener('ended', unlockAfterAudio);
botAudio.addEventListener('error', unlockAfterAudio);


    let isEnded = false;
    let recHandle = null;

    // ëª¨ë“œë³„ ì´ˆê¸° UI
    if (cond === 'voice') {
  document.body.classList.add('voice');
  title.textContent = 'ë…ê° ì˜ˆë°© ì ‘ì¢…ì— ëŒ€í•´ ë¬¼ì–´ë³´ì„¸ìš”! (ì˜ˆ: ì ‘ì¢… íš¨ê³¼, ì•ˆì „ì„±, í•„ìš”ì„±)';
  speakBtn.style.display = 'inline-block';
  textControls.style.display = 'none';
  tip.style.display = 'block'; // â† ë³´ì´ë„ë¡ ìœ ì§€
  tip.textContent = 'Tip: "ëˆŒëŸ¬ì„œ ë§í•˜ê¸°" ë²„íŠ¼ì„ ëˆ„ë¥¸ ë‹¤ìŒ ë§ì”€í•˜ì„¸ìš”.';
} else {
      title.textContent = 'ë…ê° ì˜ˆë°© ì ‘ì¢…ì— ëŒ€í•´ ë¬¼ì–´ë³´ì„¸ìš”! (ì˜ˆ: ì ‘ì¢… íš¨ê³¼, ì•ˆì „ì„±, í•„ìš”ì„±)';
      speakBtn.style.display = 'none';
      textControls.style.display = 'flex';
      tip.textContent = 'Tip: ì…ë ¥ì°½ì— ì§ˆë¬¸ì„ ì ê³  â€œë³´ë‚´ê¸°â€ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.';
    }

    // ì±„íŒ… ë§í’ì„  ìœ í‹¸(í…ìŠ¤íŠ¸ ëª¨ë“œì—ì„œë§Œ ì‹œê°ì ìœ¼ë¡œ ë³´ì„)
    function addMsg(role, text, asThinking=false){
      const row = document.createElement('div');
      row.className = `row ${role}`;
      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.textContent = role === 'user' ? 'ìœ ì €' : 'ì±—ë´‡';
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      if(asThinking){
        const wrap = document.createElement('div');
        wrap.className = 'dots';
        wrap.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
        bubble.appendChild(wrap);
      }else{
        bubble.textContent = text;
      }
      if(role === 'bot'){ row.appendChild(avatar); row.appendChild(bubble); }
      else { row.appendChild(bubble); row.appendChild(avatar); }
      chat.appendChild(row); chat.scrollTop = chat.scrollHeight;
      return {row,bubble};
    }
    const updateThinking = (el,text) => { if(el) el.textContent = text; };

    // í…ìŠ¤íŠ¸ ëª¨ë“œ ì „ì†¡
    async function sendText(){
      if (isEnded) return;
      const text = userInput.value.trim(); if(!text) return;
      userInput.value = '';
      addMsg('user', text);
      const thinking = addMsg('bot','',true);
      try{
        const t0 = performance.now();
        const r = await fetch(`${API_BASE}/query`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ text, lang:'ko', cond, pid, code: surveyCode })
        });
        const data = await r.json();
        const reply = data.reply || '(ì‘ë‹µ ì—†ìŒ)';
        updateThinking(thinking.bubble, reply);

        if (cond === 'voice' && data.audio) {
          botAudio.src = `data:${data.mime || 'audio/mpeg'};base64,${data.audio}`;
          try { await botAudio.play(); } catch(_){}
        }

        window.parent?.postMessage({pid,cond,rt_ms:Math.round(performance.now()-t0),user:text,bot:reply},'*');
      }catch(e){
        updateThinking(thinking.bubble,'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
      }
    }

    // ë³´ì´ìŠ¤: í•œ ë²ˆ ëˆŒëŸ¬ 1ë¬¸ì¥ ì¸ì‹ â†’ TTS ëë‚  ë•Œê¹Œì§€ ë²„íŠ¼ ì ê¸ˆ
    async function startRecognize(){
      if (isEnded) return;
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR){ alert('Chrome ë˜ëŠ” Edge ë¸Œë¼ìš°ì €ì—ì„œ ì‚¬ìš©í•˜ì„¸ìš”.'); return; }

      const rec = new SR();
      recHandle = rec;
      rec.lang = 'ko-KR';
      rec.interimResults = false;
      rec.maxAlternatives = 1;
      rec.continuous = false; // ë‹¨ë°œ

      // í´ë¦­ ì¦‰ì‹œ ë²„íŠ¼ ì ê¸ˆ
      speakBtn.disabled = true;

      // í•´ì œ ë³´ì¥ (ì¤‘ë³µ ë°©ì§€ + ì˜¤ë””ì˜¤ ì¬ìƒ ì¤‘ì—” ê¸ˆì§€)
      let unlocked = false;
      let gotResult = false;
      let isPlaying = false;
      const unlock = () => {
        if (unlocked || isEnded) return;
        if (isPlaying) return;
        unlocked = true;
        speakBtn.disabled = false;
      };

      try { rec.start(); } catch(_) { unlock(); return; }

      rec.onresult = async (e) => {
        if (isEnded) { unlock(); return; }
        gotResult = true;
        const text = e.results[0][0].transcript;

        try{
          const t0 = performance.now();
          const r = await fetch(`${API_BASE}/query`, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({ text, lang:'ko', cond, pid })
          });
          const data = await r.json();
          const reply = data.reply || '(ì‘ë‹µ ì—†ìŒ)';

          // (ë³´ì´ìŠ¤ ëª¨ë“œì—ì„  ë§í’ì„  ì¶œë ¥ ì•ˆ í•¨)

          if (data.audio){
            isPlaying = true;
            botAudio.onended = () => { isPlaying = false; unlock(); };
            botAudio.onerror = () => { isPlaying = false; unlock(); };
            botAudio.src = `data:${data.mime || 'audio/mpeg'};base64,${data.audio}`;
            try { await botAudio.play(); } catch(_){ isPlaying = false; unlock(); }
          } else {
            unlock();
          }

          window.parent?.postMessage({pid,cond,rt_ms:Math.round(performance.now()-t0),user:text,bot:reply},'*');
        } catch(_){
          unlock();
        }
      };

      rec.onend   = () => { if (!isEnded && !gotResult) unlock(); else if (!isEnded && !isPlaying) unlock(); };
      rec.onerror = () => { if (!isEnded) unlock(); };
    }

    // ì´ë²¤íŠ¸
    if (cond==='voice') speakBtn.addEventListener('click', startRecognize);
    else {
      sendBtn.addEventListener('click', sendText);
      userInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter') sendText(); });
      addMsg('bot','ì•„ë˜ì— ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
    }

    // 3ë¶„ íƒ€ì´ë¨¸: ë³´ì´ìŠ¤ëŠ” ì˜¤ë””ì˜¤ë§Œ, í…ìŠ¤íŠ¸ëŠ” ë§í’ì„ 
    setTimeout(async () => {
      if (isEnded) return;
      isEnded = true;

      try { recHandle?.abort?.(); } catch(_) {}

      if (cond === 'voice') {
        try {
          const r = await fetch(`${API_BASE}/end-audio`);
          const data = await r.json();
          if (data.audio) {
            botAudio.src = `data:${data.mime || 'audio/mpeg'};base64,${data.audio}`;
            try { await botAudio.play(); } catch(_) {}
          }
        } catch(_) {}
      } else {
        const thinking = addMsg('bot','',true);
        updateThinking(thinking.bubble, 'ëŒ€í™” ì‹œê°„ì´ ëë‚¬ì–´ìš”. ì„¤ë¬¸ìœ¼ë¡œ ëŒì•„ê°€ ì•„ë˜ ë³¸ì¸í™•ì¸ì½”ë“œë¥¼ ì…ë ¥í•˜ê³  ì´ì–´ì„œ ì„¤ë¬¸ì— ë‹µë³€í•´ ì£¼ì„¸ìš”. ê°ì‚¬í•©ë‹ˆë‹¤!');
        // ì•ˆë‚´ ë§í’ì„ ì€ ê·¸ëŒ€ë¡œ ë‘ê³ , í™”ë©´ì— ë³„ë„ ì½”ë“œ ë°•ìŠ¤ í‘œì‹œ
if (codeBox && codeText) {
  codeText.textContent = surveyCode;
  codeBox.style.display = 'flex';
  try { await navigator.clipboard.writeText(surveyCode); } catch(_) {} // (ì„ íƒ) ìë™ ë³µì‚¬
}
      }

      if (userInput) userInput.disabled = true;
      if (sendBtn) sendBtn.disabled = true;
      if (speakBtn) speakBtn.disabled = true;
    }, 120000);
    copyCode?.addEventListener('click', async () => {
  try {
    await navigator.clipboard.writeText(surveyCode);
    copyCode.textContent = 'ë³µì‚¬ë¨!';
    setTimeout(() => (copyCode.textContent = 'ì½”ë“œ ë³µì‚¬'), 1200);
  } catch(_) {}
});

  </script>
</body>
</html>















